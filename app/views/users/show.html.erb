<script>
    $(document).ready(function() {
        $("#add-role").bind('ajax:success', function(evt, data, status, xhr) {
            updateUserRoleList(data);
        })

        $("#user-role-list").on("click", "a", function() {
            $.ajax({
                type: "POST",
                url: "/users/<%= params[:id] %>/remove_role",
                data: { role: $(this).attr("data-id") },
                success: function(response, textStatus, jqXHR) {
                    updateUserRoleList(response);
                }
            });
        });
    });

    var updateUserRoleList = function(data) {
        $("#user-role-list").empty();
        for(var i = 0; i < data.length; i++) {
            $("#user-role-list").append('<li>' + data[i].role.name +
                    ' <a href="#" data-id="' + data[i].role.id +
                    '">Remove</a></li>');
        }
    };
</script>

<h1><%= @user.full_name %></h1>

<dl>
  <dt>E-mail</dt>
  <dd><%= @user.email %></dd>
</dl>

<h2>Roles</h2>

<ul id="user-role-list">
<% @user.roles.each do |role| -%>
  <li><%= role.name %> <a href="#" data-id="<%= role.id %>">Remove</a></li>
<% end -%>
</ul>

<% if (can? :manage, Functionary) %>
    <p>Give this user a new role:</p>
    <%= form_tag({:action => 'add_role'}, :remote => true, :id => "add-role") do %>
        <%= collection_select(:role, :id, Role.all, :id, :name) %>
        <%= submit_tag("Add", class: "btn btn-primary") %>
    <% end %>
<% end %>
