<% content_for :sidebar_left do %>
  <% form_for :participant, @search_participant, :url => { :action => "index" },
    :html => {:method => "get", :class => "search"} do |f| %>
      <ul class="vlist">
        <li><b>First name: </b></li><li><%= f.text_field :first_name %></li>
        <li><b>Last name: </b></li><li><%= f.text_field :last_name %></li>
        <li><b>E-mail address: </b></li><li><%= f.text_field :email %></li>
        <%unless ( @search_participant.nil? )%>
          <%unless @search_participant.country.nil? %>
            <li><b>Country: </b></li><li><%= collection_select(:participant, :country_id, Country.all, :id, :name, {:prompt => "Select a country", :selected=>@search_participant.country_id.to_s}) %></li>
          <% else %>
            <li><b>Country: </b></li><li><%= collection_select(:participant, :country_id, Country.all, :id, :name, {:prompt => "Select a country"}) %></li>
          <% end %>
          <%unless @search_participant.workshop.nil? %>
            <li><b>Workshop: </b></li><li><%= collection_select(:participant, :workshop_id, Workshop.all, :id, :name, {:prompt => "Select a workshop", :selected=>@search_participant.workshop_id.to_s}) %></li>
          <%else%>
            <li><b>Workshop: </b></li><li><%= collection_select(:participant, :workshop_id, Workshop.all, :id, :name, {:prompt => "Select a workshop"}) %></li>
          <% end %>
        <% else %>
          <li><b>Country: </b></li><li><%= collection_select(:participant, :country_id, Country.all, :id, :name, {:prompt => "Select a country"}) %></li>
          <li><b>Workshop: </b></li><li><%= collection_select(:participant, :workshop_id, Workshop.all, :id, :name, {:prompt => "Select a workshop"}) %></li>
        <%end%>
        <li><b>Got visa?: </b></li><li><%= f.check_box :visa %></li>
        <li><b>Accepted?: </b></li><li><%= f.check_box :accepted %></li>
        <li><b>Has passport?: </b></li><li><%= f.check_box :has_passport %></li>
        <li><b>Applied for visa?: </b></li><li><%= f.check_box :applied_for_visa %></li>
        <li><b>Refnumber?: </b></li><li><%= f.check_box :flightnumber %></li>
        <li><b>Travel support?: </b></li><li><%= f.check_box :travel_support %></li>
    </ul></ul>

    <br />
    <%= f.submit 'Search' %> <%= link_to (submit_tag 'Show all', :type => 'button'), :action=>:index %><br>
  <% end %>
<% end %>
<% content_for :sidebar_right do %>
  <h2>Transport</h2>
  <h4>Trondheim</h4>
  <p class="info">
    <% @trondheim = @partici.where(:arrival_place_id => 1) %>
    Total: <%= @trondheim.count %><br>
    Arrivals by plane: <%= @trondheim.where(:transport_type_id => 1).count %><br>
    Arrivals by train: <%= @trondheim.where(:transport_type_id => 2).count %><br>
    Arrivals by bus: <%= @trondheim.where(:transport_type_id => 3).count %><br>
  </p>
  <h4>Oslo</h4>
  <p class="info">
    <% @oslo = @partici.where(:arrival_place_id => 2) %>
    Total: <%= @oslo.count %><br>
    Arrivals by plane: <%= @oslo.where(:transport_type_id => 1).count %><br>
    Arrivals by train: <%= @oslo.where(:transport_type_id => 2).count %><br>
    Arrivals by bus: <%= @oslo.where(:transport_type_id => 3).count %><br>
    Needs transport from Oslo: <%= @oslo.where(:need_transport => 1).count %><br>
  </p>
<% end %>
<script>
  $(function() {
    $("div#statistics").hide();
    $("#toggle-stat").click(function() {
      $("div#statistics").toggle("slow");
    });
  });
</script>
<a id="toggle-stat">Toggle statistics</a>
<div id="statistics">
  <p class="info">
    All info below are from the active search.
  </p>
  <script>
    $(function() {
      $("#country-dist").hide();
      $("#country-dist-toggle").click(function() {
        $("#country-dist").toggle("slow");
      });
    });
  </script>
  <h3><a id="country-dist-toggle">Total country distribution</a></h3>
  <div id="country-dist">
    <p class="info"><%= @partici.count %> total</p>
    <table id="datatable-country">
      <thead>
        <tr>
          <th>Country</th>
          <th>Participants</th>
        </tr>
      </thead>
      <tbody>
        <% @country_count.each do |c| %>
          <tr>
            <td><%= @countries[c[0]].name %></td><td><%= c[1] %></td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
  <% @workshops.each do |w| %>
    <% @w_part_count = @partici.where(:workshop_id => w.id).group(:country_id).count.sort_by{|k,v| v}.reverse %>
    <script>
      $(function() {
        $("#workshop<%= w.id %>-dist").hide();
        $("#workshop<%= w.id %>-dist-toggle").click(function() {
          $("#workshop<%= w.id %>-dist").toggle("slow");
        });
      });
    </script>
    <% if @w_part_count.nil?
    next
  end
%>
<h3><a id="workshop<%= w.id %>-dist-toggle">Workshop <%= w.id %> distribution</a></h3>
<div id="workshop<%= w.id %>-dist">
  <p class="info"><%= @workshop_count[w.id] %> participants in this workshop</p>
  <table id="datatable<%= w.id %>">
    <thead>
      <tr>
        <th>Country</th>
        <th>Participants</th>
      </tr>
    </thead>
    <tbody>
      <% @w_part_count.each do |c| %>
        <tr>
          <td><%= @countries[c[0]].name %></td><td><%= c[1] %></td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>
  <% end %>

</div>


<div id="index_table">
  <%= render :partial => "participants" %>
  <%= will_paginate @participants%>
</div>

